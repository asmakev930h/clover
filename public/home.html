<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Home - Clover</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="/socket.io/socket.io.js"></script>

    <style>
        /* --- RESET & CORE STYLES --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { min-height: 100vh; background-color: #0f0f1a; color: #fff; overflow: hidden; position: relative; }
        
        /* --- AURORA BACKGROUND --- */
        body::before {
            content: ''; position: fixed; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, #4F46E5 0%, #7C3AED 30%, #EC4899 60%, #0f0f1a 80%);
            background-size: 200% 200%; animation: auroraMove 20s ease infinite alternate; opacity: 0.4; z-index: -2; filter: blur(80px); pointer-events: none;
        }
        @keyframes auroraMove { 0% { transform: translate(0, 0) rotate(0deg); } 50% { transform: translate(-5%, 5%) rotate(5deg); } 100% { transform: translate(5%, -5%) rotate(-5deg); } }

        .app-container { width: 100%; height: 100vh; display: flex; flex-direction: column; position: relative; }
        header { padding: 20px 25px; display: flex; justify-content: space-between; align-items: center; background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255, 255, 255, 0.05); z-index: 10; }
        .brand-logo { font-size: 20px; font-weight: 800; letter-spacing: 2px; text-transform: uppercase; background: linear-gradient(135deg, #ffffff 10%, #c4b5fd 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: flex; align-items: center; gap: 8px; }
        .brand-icon { font-size: 18px; background: linear-gradient(135deg, #fff 0%, #a78bfa 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; transform: rotate(-10deg); }
        .header-actions i { font-size: 20px; color: rgba(255,255,255,0.7); margin-left: 20px; cursor: pointer; transition: 0.3s; }
        
        main { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; display: none; animation: fadeIn 0.4s ease-out; }
        main.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        h2.section-title { font-size: 28px; margin-bottom: 15px; font-weight: 700; }
        .glass-card { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px; padding: 20px; margin-bottom: 15px; backdrop-filter: blur(10px); }
        
        /* --- VERIFIED BADGE STYLES --- */
        .verified-badge {
            display: inline-flex; align-items: center; justify-content: center;
            margin-left: 6px; vertical-align: middle;
            color: #38bdf8;
            font-size: 0.9em;
            filter: drop-shadow(0 0 8px rgba(56, 189, 248, 0.6));
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            cursor: pointer; opacity: 0; transform: scale(0);
        }
        @keyframes popIn { 100% { opacity: 1; transform: scale(1); } }
        
        /* --- UNREAD COUNT BADGE --- */
        .unread-badge {
            background-color: #10B981;
            color: #fff;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: auto;
            min-width: 18px;
            text-align: center;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.4);
        }

        .story-scroll { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 20px; }
        .story-scroll::-webkit-scrollbar { display: none; }
        .story-circle { width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #4F46E5, #EC4899); padding: 2px; flex-shrink: 0; }
        .story-inner { width: 100%; height: 100%; background: #222; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; }

        .profile-header { text-align: center; padding: 0 0 20px; } 
        
        .profile-avatar-container { position: relative; width: 100px; height: 100px; margin: 0 auto 15px; }
        .profile-avatar { width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #4F46E5, #EC4899); display: flex; align-items: center; justify-content: center; font-size: 40px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); overflow: hidden; background-size: cover; background-position: center; }
        .edit-avatar-btn { position: absolute; bottom: 0; right: 0; background: #fff; color: #000; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.3); transition: transform 0.2s; }
        .edit-avatar-btn:active { transform: scale(0.9); }
        
        .settings-btn { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); padding: 12px 20px; border-radius: 15px; width: 100%; font-weight: 600; color: #fff; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 10px; cursor: pointer; transition: 0.3s; }
        .settings-btn:hover { background: rgba(255, 255, 255, 0.15); transform: translateY(-2px); }
        .btn-danger { background: rgba(239, 68, 68, 0.15); border-color: rgba(239, 68, 68, 0.4); color: #fca5a5; }
        .btn-danger:hover { background: rgba(239, 68, 68, 0.3); color: #fff; }

        .custom-alert { position: fixed; top: 30px; left: 50%; transform: translateX(-50%) translateY(-500%); background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); padding: 16px 30px; border-radius: 50px; border: 1px solid rgba(255, 255, 255, 0.2); color: #fff; font-size: 14px; font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 9999; opacity: 0; transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease; display: flex; align-items: center; gap: 12px; pointer-events: none; }
        .custom-alert.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .custom-alert.error { border-color: rgba(239, 68, 68, 0.5); background: rgba(239, 68, 68, 0.15); }
        .custom-alert.success { border-color: rgba(16, 185, 129, 0.5); background: rgba(16, 185, 129, 0.15); }
        .custom-alert.info { border-color: #38bdf8; background: rgba(56, 189, 248, 0.15); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal-content { width: 90%; max-width: 350px; background: rgba(30, 30, 45, 0.9); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 25px; padding: 25px; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 15px 40px rgba(0,0,0,0.5); }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-content h3 { margin-bottom: 20px; text-align: center; }
        
        .input-group { position: relative; margin-bottom: 15px; }
        .modal-input { width: 100%; padding: 12px 15px; padding-right: 45px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 10px; color: #fff; outline: none; }
        .modal-input:focus { border-color: #c4b5fd; }
        .toggle-password { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: rgba(255, 255, 255, 0.5); transition: 0.3s; padding: 5px; }
        .toggle-password:hover { color: #fff; }

        .feedback-container { height: 20px; margin-bottom: 10px; padding: 0 5px; display: flex; align-items: center; }
        .strength-bar-bg { width: 100%; height: 4px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; overflow: hidden; display: none; position: relative; }
        .strength-bar-fill { height: 100%; width: 0%; border-radius: 10px; transition: width 0.3s, background 0.3s; }
        .feedback-text { font-size: 11px; font-weight: 500; opacity: 0; transition: opacity 0.3s; margin-left: 8px; white-space: nowrap; }
        .text-weak { color: #ef4444; } .text-medium { color: #f59e0b; } .text-strong { color: #10b981; } .text-match { color: #10b981; } .text-mismatch { color: #ef4444; }

        .modal-actions { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 10px; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; }
        .btn-cancel { background: rgba(255, 255, 255, 0.1); color: #fff; }
        .btn-save { background: linear-gradient(135deg, #4F46E5, #EC4899); color: #fff; }

        .bottom-nav { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; height: 70px; background: rgba(20, 20, 35, 0.6); backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 50px; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: rgba(255, 255, 255, 0.4); cursor: pointer; transition: all 0.3s ease; position: relative; width: 60px; }
        .nav-item i { font-size: 22px; margin-bottom: 4px; transition: transform 0.3s; }
        .nav-item span { font-size: 10px; font-weight: 600; opacity: 0; transform: translateY(10px); transition: all 0.3s ease; position: absolute; bottom: -15px; }
        .nav-item.active { color: #fff; }
        .nav-item.active i { transform: translateY(-8px); background: linear-gradient(135deg, #c4b5fd, #fff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .nav-item.active span { opacity: 1; transform: translateY(0); }
    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <div class="brand-logo"> <i class="fa-solid fa-clover brand-icon"></i> CLOVER </div>
            <div class="header-actions"> <i class="fa-solid fa-magnifying-glass"></i> <i class="fa-regular fa-bell"></i> </div>
        </header>

        <main id="section-home" class="active">
            <h2 class="section-title">Home</h2>
            <div class="story-scroll">
                <div class="story-circle"><div class="story-inner"><i class="fa-solid fa-plus"></i></div></div>
                <div class="story-circle"><div class="story-inner">ü¶Å</div></div>
                <div class="story-circle"><div class="story-inner">üçï</div></div>
                <div class="story-circle"><div class="story-inner">‚úàÔ∏è</div></div>
            </div>
            <div class="glass-card">
                <h3>Welcome back!</h3>
                <p>Hello <span id="userNameDisplay" style="font-weight:bold; color:#c4b5fd;">User</span>, explore the new updates.</p>
            </div>
        </main>

        <main id="section-chats">
            <h2 class="section-title">Chats</h2>
            <div id="chatListContainer">
                <div style="text-align:center; padding:20px; color:rgba(255,255,255,0.4); font-size:13px;">
                    <i class="fa-solid fa-spinner fa-spin"></i> Loading chats...
                </div>
            </div>
        </main>

        <main id="section-profile">
            <h2 class="section-title">Profile</h2>
            
            <div class="profile-header">
                <div class="profile-avatar-container">
                    <div id="profileAvatar" class="profile-avatar">
                        <i class="fa-regular fa-user"></i>
                    </div>
                    <div class="edit-avatar-btn" onclick="document.getElementById('fileInput').click()">
                        <i class="fa-solid fa-camera"></i>
                    </div>
                </div>
                
                <div style="display: flex; align-items: center; justify-content: center; gap: 4px;">
                    <h3 id="profileName" style="margin-bottom:0;">My Account</h3>
                    <span id="profileBadgeContainer"></span>
                </div>

                <p id="userUsernameDisplay" style="font-size:14px; opacity:0.7; margin-bottom:5px; color:#a5b4fc;">@username</p>
                
                <p id="userEmailDisplay" style="font-size:13px; opacity:0.8; margin-top:2px; color:#c4b5fd;">Loading email...</p>
                <p style="font-size:12px; opacity:0.6; font-family:monospace; margin-top:5px;">ID: <span id="userIdDisplay">...</span></p>
                
                <input type="file" id="fileInput" accept="image/*" hidden>
                <p id="uploadStatus" style="font-size:11px; margin-top:5px; height:15px;"></p>
            </div>

            <div class="glass-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; cursor:pointer;" onclick="openEditModal()"> 
                    <span>Edit Profile</span> 
                    <i class="fa-solid fa-pen-to-square" style="opacity:0.8; color:#c4b5fd;"></i> 
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; cursor:pointer;" onclick="openChangePasswordModal()"> 
                    <span>Change Password</span> 
                    <i class="fa-solid fa-lock" style="opacity:0.8; color:#c4b5fd;"></i> 
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; cursor:pointer;" onclick="openSettingsModal()"> 
                    <span>Settings</span> 
                    <i class="fa-solid fa-gear" style="opacity:0.8; color:#c4b5fd;"></i> 
                </div>
            </div>
        </main>

        <div id="editProfileModal" class="modal-overlay">
            <div class="modal-content">
                <h3>Edit Profile</h3>
                <div class="input-group"><input type="text" id="editFullname" class="modal-input" placeholder="Full Name"></div>
                <div class="input-group"><input type="email" id="editEmail" class="modal-input" placeholder="Email Address"></div>
                <div class="modal-actions">
                    <button class="modal-btn btn-cancel" onclick="closeModal('editProfileModal')">Cancel</button>
                    <button id="saveBtn" class="modal-btn btn-save" onclick="saveProfileChanges()">Save</button>
                </div>
            </div>
        </div>

        <div id="changePasswordModal" class="modal-overlay">
            <div class="modal-content">
                <h3>Change Password</h3>
                <div class="input-group">
                    <input type="password" id="currentPass" class="modal-input" placeholder="Current Password">
                    <i class="fa-regular fa-eye toggle-password" onclick="togglePass('currentPass', this)"></i>
                </div>
                <div class="input-group">
                    <input type="password" id="newPass" class="modal-input" placeholder="New Password">
                    <i class="fa-regular fa-eye toggle-password" onclick="togglePass('newPass', this)"></i>
                </div>
                <div class="feedback-container">
                    <div class="strength-bar-bg" id="strengthBarBg"> <div class="strength-bar-fill" id="strengthFill"></div> </div>
                    <span id="strengthText" class="feedback-text"></span>
                </div>
                <div class="input-group">
                    <input type="password" id="confirmNewPass" class="modal-input" placeholder="Confirm New Password">
                    <i class="fa-regular fa-eye toggle-password" onclick="togglePass('confirmNewPass', this)"></i>
                </div>
                <div class="feedback-container"> <span id="matchText" class="feedback-text"></span> </div>
                <div class="modal-actions">
                    <button class="modal-btn btn-cancel" onclick="closeModal('changePasswordModal')">Cancel</button>
                    <button id="savePassBtn" class="modal-btn btn-save" onclick="savePasswordChange()">Update</button>
                </div>
            </div>
        </div>

        <div id="settingsModal" class="modal-overlay">
            <div class="modal-content">
                <h3>Settings</h3>
                <button onclick="removeProfileImage()" class="settings-btn">
                    <i class="fa-solid fa-image-portrait"></i> Remove Profile Picture
                </button>
                <button onclick="openDeleteAccountModal()" class="settings-btn btn-danger">
                    <i class="fa-solid fa-trash"></i> Delete Account
                </button>
                <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin:15px 0;">
                <button id="logoutBtn" class="settings-btn btn-danger"> 
                    <i class="fa-solid fa-right-from-bracket"></i> Logout 
                </button>
                <button class="modal-btn btn-cancel" style="margin-top:10px; width:100%" onclick="closeModal('settingsModal')">Close</button>
            </div>
        </div>

        <div id="deleteAccountModal" class="modal-overlay">
            <div class="modal-content">
                <h3 style="color:#ef4444;">Delete Account?</h3>
                <p style="text-align:center; font-size:13px; color:rgba(255,255,255,0.7); margin-bottom:15px;">Irreversible action. Enter password.</p>
                <div class="input-group">
                    <input type="password" id="deletePass" class="modal-input" placeholder="Password">
                    <i class="fa-regular fa-eye toggle-password" onclick="togglePass('deletePass', this)"></i>
                </div>
                <div class="modal-actions">
                    <button class="modal-btn btn-cancel" onclick="closeModal('deleteAccountModal')">Cancel</button>
                    <button id="confirmDeleteBtn" class="modal-btn btn-save" style="background:#ef4444;" onclick="confirmDeleteAccount()">Delete</button>
                </div>
            </div>
        </div>

        <div id="customAlert" class="custom-alert">
            <i id="alertIcon" class="fa-solid"></i>
            <span id="alertMessage"></span>
        </div>

        <div class="bottom-nav">
            <div class="nav-item" onclick="window.location.hash='home'" data-target="home"> <i class="fa-solid fa-house"></i> <span>Home</span> </div>
            <div class="nav-item" onclick="window.location.hash='chats'" data-target="chats"> <i class="fa-solid fa-comment"></i> <span>Chats</span> </div>
            <div class="nav-item" onclick="window.location.hash='profile'" data-target="profile"> <i class="fa-regular fa-user"></i> <span>Profile</span> </div>
        </div>
    </div>

    <script>
        const socket = io(); // Initialize Socket
        let currentUserData = {};

        function showAlert(message, type) {
            const alertBox = document.getElementById('customAlert'); const alertMsg = document.getElementById('alertMessage'); const alertIcon = document.getElementById('alertIcon');
            alertBox.className = 'custom-alert'; alertIcon.className = 'fa-solid'; alertMsg.innerText = message;
            
            // Reset classes
            alertBox.classList.remove('error', 'success', 'info');
            alertIcon.classList.remove('fa-circle-exclamation', 'fa-circle-check', 'fa-circle-info');

            if (type === 'error') { alertBox.classList.add('error'); alertIcon.classList.add('fa-circle-exclamation'); }
            else if (type === 'success') { alertBox.classList.add('success'); alertIcon.classList.add('fa-circle-check'); }
            else if (type === 'info') { alertBox.classList.add('info'); alertIcon.classList.add('fa-circle-info'); }
            
            requestAnimationFrame(() => alertBox.classList.add('show'));
            setTimeout(() => alertBox.classList.remove('show'), 3000);
        }

        async function verifyUser() {
            const userId = localStorage.getItem('userId');
            if (!userId) { window.location.href = '/login'; return; }
            try {
                const response = await fetch('/auth/verify', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId: userId }) });
                const data = await response.json();
                if (!response.ok || !data.valid) { throw new Error('Invalid Session'); }
                
                currentUserData = data.user;
                localStorage.setItem('userProfileId', data.user.profileId);
                
                // --- JOIN HOME CHANNEL FOR LIVE UPDATES ---
                socket.emit('join_home', data.user.profileId);
                
                // --- LOAD CHATS ---
                loadMyChats();

                document.getElementById('userIdDisplay').innerText = data.user.profileId;
                
                const welcomeNameEl = document.getElementById('userNameDisplay');
                welcomeNameEl.innerHTML = data.user.fullname.split(' ')[0];
                
                const profileNameEl = document.getElementById('profileName');
                profileNameEl.innerHTML = data.user.fullname;
                
                const badgeHTML = `
                    <span class="verified-badge" onclick="showAlert('Verified Account: Official User', 'info')">
                        <i class="fa-solid fa-circle-check"></i>
                    </span>`;

                if (data.user.VerifiedBarge === true) {
                    document.getElementById('profileBadgeContainer').innerHTML = badgeHTML;
                    welcomeNameEl.innerHTML += badgeHTML;
                } else {
                    document.getElementById('profileBadgeContainer').innerHTML = '';
                }

                document.getElementById('userUsernameDisplay').innerText = '@' + data.user.username;
                document.getElementById('userEmailDisplay').innerText = data.user.email;
                if (data.user.profileImage) { setAvatarImage(data.user.profileImage); }
            } catch (error) { localStorage.removeItem('userId'); window.location.href = '/login'; }
        }

        function setAvatarImage(url) { 
            const avatar = document.getElementById('profileAvatar'); 
            avatar.innerHTML = ''; 
            if(url) { avatar.style.backgroundImage = `url('${url}')`; }
            else { avatar.style.backgroundImage = 'none'; avatar.innerHTML = '<i class="fa-regular fa-user"></i>'; }
        }
        
        // --- UPDATED LOAD CHATS WITH IMAGE PASSING ---
        async function loadMyChats() {
            const userId = localStorage.getItem('userId');
            if (!userId) return;

            try {
                const response = await fetch(`/api/my-chats?userId=${userId}`);
                const data = await response.json();
                const container = document.getElementById('chatListContainer');
                
                if (!data.chats || data.chats.length === 0) {
                    container.innerHTML = `
                        <div style="text-align:center; padding:40px; opacity:0.5;">
                            <i class="fa-regular fa-comments" style="font-size:30px; margin-bottom:10px;"></i>
                            <p>No messages yet.</p>
                            <p style="font-size:12px;">Start a chat by finding a user!</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = ''; 

                data.chats.forEach(chat => {
                    let preview = chat.lastMessage;
                    if (preview.length > 30) preview = preview.substring(0, 30) + '...';

                    let avatarStyle = chat.profileImage 
                        ? `background-image: url('${chat.profileImage}'); background-size: cover;` 
                        : `background: linear-gradient(135deg, #10B981, #3B82F6); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px;`;
                    
                    let avatarContent = chat.profileImage ? '' : chat.fullname.charAt(0);

                    let badgeHtml = chat.VerifiedBarge 
                        ? `<i class="fa-solid fa-circle-check" style="color:#38bdf8; font-size:12px; margin-left:5px;"></i>` 
                        : ``;

                    let unreadHtml = '';
                    let boldStyle = '';
                    if (chat.unreadCount > 0) {
                        unreadHtml = `<span class="unread-badge">${chat.unreadCount}</span>`;
                        boldStyle = 'font-weight:700; color:#fff;'; 
                    }

                    // --- UPDATED ONCLICK BELOW TO PASS IMAGE URL ---
                    const chatHtml = `
                        <div class="glass-card" style="display:flex; align-items:center; gap:15px; cursor:pointer; padding:15px;" 
                             onclick="window.location.href='/chat?id=${chat.profileId}'">
                            
                            <div style="width:50px; height:50px; border-radius:50%; flex-shrink:0; ${avatarStyle}">
                                ${avatarContent}
                            </div>
                            
                            <div style="flex:1; min-width:0;">
                                <h4 style="margin-bottom:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                                    ${chat.fullname} ${badgeHtml}
                                </h4>
                                <p style="font-size:12px; opacity:0.6; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; ${boldStyle}">
                                    ${preview}
                                </p>
                            </div>
                            
                            ${unreadHtml}
                        </div>
                    `;
                    container.innerHTML += chatHtml;
                });

            } catch (error) {
                console.error(error);
            }
        }
        
        // --- SOCKET LISTENER FOR LIVE CHAT LIST UPDATE ---
        socket.on('update_home_chats', () => {
            loadMyChats();
        });

        verifyUser();

        // (Existing helper functions: togglePass, calculateStrength, etc.)
        function togglePass(inputId, icon) {
            const input = document.getElementById(inputId);
            input.setAttribute('type', input.getAttribute('type') === 'password' ? 'text' : 'password');
            icon.classList.toggle('fa-eye'); icon.classList.toggle('fa-eye-slash');
        }

        function calculateStrength(val) {
            let score = 0;
            if(val.length >= 8) score++; if(/[0-9]/.test(val)) score++; if(/[!@#$%^&*]/.test(val)) score++; if(/[A-Z]/.test(val)) score++;
            return score;
        }

        const newPassInput = document.getElementById('newPass');
        const confirmPassInput = document.getElementById('confirmNewPass');
        const strengthBarBg = document.getElementById('strengthBarBg');
        const strengthFill = document.getElementById('strengthFill');
        const strengthText = document.getElementById('strengthText');
        const matchText = document.getElementById('matchText');

        newPassInput.addEventListener('input', () => {
            const val = newPassInput.value;
            if(val.length > 0) { strengthBarBg.style.display = 'block'; strengthText.style.opacity = '1'; } else { strengthBarBg.style.display = 'none'; strengthText.style.opacity = '0'; return; }
            let score = calculateStrength(val);
            if(val.length < 6) { strengthFill.style.width = '20%'; strengthFill.style.backgroundColor = '#ef4444'; strengthText.innerText = 'Too Short'; strengthText.className = 'feedback-text text-weak'; }
            else if(score < 3) { strengthFill.style.width = '60%'; strengthFill.style.backgroundColor = '#f59e0b'; strengthText.innerText = 'Medium'; strengthText.className = 'feedback-text text-medium'; }
            else { strengthFill.style.width = '100%'; strengthFill.style.backgroundColor = '#10b981'; strengthText.innerText = 'Strong'; strengthText.className = 'feedback-text text-strong'; }
            checkMatch();
        });

        confirmPassInput.addEventListener('input', checkMatch);
        function checkMatch() {
            const pass = newPassInput.value; const conf = confirmPassInput.value;
            if (conf.length === 0) { matchText.style.opacity = '0'; return; }
            matchText.style.opacity = '1';
            if (pass === conf) { matchText.innerHTML = '<i class="fa-solid fa-check"></i> Match'; matchText.className = 'feedback-text text-match'; }
            else { matchText.innerHTML = '<i class="fa-solid fa-xmark"></i> Mismatch'; matchText.className = 'feedback-text text-mismatch'; }
        }

        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function openEditModal() { document.getElementById('editFullname').value = currentUserData.fullname || ""; document.getElementById('editEmail').value = currentUserData.email || ""; document.getElementById('editProfileModal').classList.add('active'); }
        function openChangePasswordModal() {
            document.getElementById('currentPass').value = ""; document.getElementById('newPass').value = ""; document.getElementById('confirmNewPass').value = "";
            strengthBarBg.style.display = 'none'; strengthText.style.opacity = '0'; matchText.style.opacity = '0';
            document.getElementById('changePasswordModal').classList.add('active');
        }
        function openSettingsModal() { document.getElementById('settingsModal').classList.add('active'); }
        function openDeleteAccountModal() { closeModal('settingsModal'); document.getElementById('deletePass').value = ""; document.getElementById('deleteAccountModal').classList.add('active'); }

        async function saveProfileChanges() {
            const fullname = document.getElementById('editFullname').value; const email = document.getElementById('editEmail').value; const saveBtn = document.getElementById('saveBtn'); const userId = localStorage.getItem('userId');
            if(!fullname || !email) { showAlert("Please fill in all fields", "error"); return; }
            saveBtn.innerText = "Saving..."; saveBtn.disabled = true;
            try {
                const response = await fetch('/auth/update-profile', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId, fullname, email }) });
                const data = await response.json();
                if (response.ok) {
                    document.getElementById('profileName').innerText = fullname; document.getElementById('userEmailDisplay').innerText = email; document.getElementById('userNameDisplay').innerText = fullname.split(' ')[0];
                    currentUserData.fullname = fullname; currentUserData.email = email;
                    verifyUser();
                    closeModal('editProfileModal'); showAlert("Profile updated successfully!", "success");
                } else { showAlert(data.error || "Update failed", "error"); }
            } catch (error) { showAlert("Error updating profile", "error"); }
            saveBtn.innerText = "Save"; saveBtn.disabled = false;
        }

        async function savePasswordChange() {
            const currentPass = document.getElementById('currentPass').value; const newPass = document.getElementById('newPass').value; const confirmNewPass = document.getElementById('confirmNewPass').value; const btn = document.getElementById('savePassBtn'); const userId = localStorage.getItem('userId');
            if (!currentPass || !newPass) { showAlert("Please fill in fields", "error"); return; }
            const score = calculateStrength(newPass);
            if (newPass.length < 8 || score < 3) { showAlert("Password must be Strong!", "error"); return; }
            if (newPass !== confirmNewPass) { showAlert("New passwords do not match", "error"); return; }
            btn.innerText = "Updating..."; btn.disabled = true;
            try {
                const response = await fetch('/auth/change-password', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId, currentPassword: currentPass, newPassword: newPass }) });
                const data = await response.json();
                if (response.ok) { showAlert("Password changed successfully!", "success"); closeModal('changePasswordModal'); } else { showAlert(data.error || "Failed to change password", "error"); }
            } catch (error) { showAlert("Server Error", "error"); }
            btn.innerText = "Update"; btn.disabled = false;
        }

        async function removeProfileImage() {
            const userId = localStorage.getItem('userId');
            if(!confirm("Are you sure you want to remove your profile picture?")) return;
            try {
                const response = await fetch('/auth/remove-profile-image', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId }) });
                if(response.ok) { setAvatarImage(null); showAlert("Profile picture removed", "success"); closeModal('settingsModal'); }
                else { showAlert("Failed to remove image", "error"); }
            } catch(e) { showAlert("Server error", "error"); }
        }

        async function confirmDeleteAccount() {
            const pass = document.getElementById('deletePass').value; const btn = document.getElementById('confirmDeleteBtn'); const userId = localStorage.getItem('userId');
            if(!pass) { showAlert("Password required", "error"); return; }
            btn.innerText = "Deleting..."; btn.disabled = true;
            try {
                const response = await fetch('/auth/delete-account', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId, password: pass }) });
                const data = await response.json();
                if(response.ok) { showAlert("Account deleted. Goodbye.", "success"); localStorage.removeItem('userId'); setTimeout(() => window.location.href = '/login', 1500); }
                else { showAlert(data.error || "Delete failed", "error"); btn.innerText = "Delete"; btn.disabled = false; }
            } catch(e) { showAlert("Server error", "error"); btn.innerText = "Delete"; btn.disabled = false; }
        }

        document.getElementById('fileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0]; if (!file) return;
            const statusText = document.getElementById('uploadStatus'); const userId = localStorage.getItem('userId');
            statusText.innerText = "Uploading..."; statusText.style.color = "#a5b4fc";
            const formData = new FormData(); formData.append('image', file); formData.append('userId', userId);
            try {
                const response = await fetch('/auth/upload-profile', { method: 'POST', body: formData });
                const data = await response.json();
                if (response.ok) { statusText.innerText = "Updated!"; statusText.style.color = "#10b981"; setAvatarImage(data.imageUrl); showAlert("Profile picture updated!", "success"); }
                else { throw new Error(data.error || "Upload failed"); }
            } catch (error) { statusText.innerText = "Failed"; statusText.style.color = "#ef4444"; showAlert(error.message, "error"); }
            e.target.value = '';
        });

        // --- ROUTING LOGIC ---
        function handleRouting() {
            // Default to 'home' if no hash exists
            const hash = window.location.hash.replace('#', '') || 'home';
            
            // 1. Reset All
            document.querySelectorAll('main').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            // 2. Activate Target
            const targetSection = document.getElementById('section-' + hash);
            const targetNav = document.querySelector(`.nav-item[data-target="${hash}"]`);
            
            if (targetSection) targetSection.classList.add('active');
            // Fallback if target doesn't exist (e.g. typo), go home
            else if (hash !== 'home') { window.location.hash = 'home'; return; }

            if (targetNav) targetNav.classList.add('active');
        }

        // Listen for hash changes and initial load
        window.addEventListener('hashchange', handleRouting);
        window.addEventListener('load', handleRouting);

        document.getElementById('logoutBtn').addEventListener('click', () => {
            const btn = document.getElementById('logoutBtn'); btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exiting...';
            localStorage.removeItem('userId'); localStorage.removeItem('userProfileId'); 
            setTimeout(() => { window.location.href = '/login'; }, 1000);
        });
    </script>
</body>
</html>
